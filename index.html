<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyFlix - Plataforma Robusta</title>
    <link id="favicon" rel="icon" type="image/x-icon" href="">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Quill.js (Editor de Texto Rico) -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

    <!-- YouTube IFrame API -->
    <script src="https://www.youtube.com/iframe_api"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Configuração de Design System -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        netflix: {
                            black: '#141414',
                            dark: '#181818',
                            red: '#E50914',
                            hover: '#2F2F2F',
                            input: '#333'
                        },
                        neon: {
                            cyan: '#00f3ff',
                            purple: '#bc13fe',
                            green: '#39ff14',
                            error: '#ff4d4d'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-in-out',
                        'spin-slow': 'spin 3s linear infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700;900&display=swap');

        body {
            background-color: #141414;
            color: #e5e5e5;
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }

        /* Scrollbar Customizada */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #141414; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #E50914; }

        .scrolling-wrapper {
            display: flex; flex-wrap: nowrap; overflow-x: auto;
            -webkit-overflow-scrolling: touch; padding-bottom: 20px; scroll-behavior: smooth;
        }
        .scrolling-wrapper::-webkit-scrollbar { display: none; }
        
        /* Cards */
        .card {
            flex: 0 0 auto; width: 300px; margin-right: 15px;
            background: #181818; border-radius: 4px; position: relative; cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover { 
            transform: scale(1.05); 
            z-index: 10;
            box-shadow: 0 0 20px rgba(0,0,0,0.7);
        }

        /* Video Player Ratio */
        .video-container {
            position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;
            border-radius: 8px; border: 1px solid #333; background: black;
        }
        .video-container iframe, .video-container div { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        /* Quill Editor Dark Theme Fix */
        .ql-toolbar { background-color: #e5e5e5; border-radius: 8px 8px 0 0; }
        .ql-container { color: #e5e5e5; font-size: 16px; border-radius: 0 0 8px 8px; background-color: #2F2F2F; border: 1px solid #444; }
        .ql-editor.ql-blank::before { color: #aaa; font-style: italic; }
        
        /* Loading Spinner */
        .loader {
            border: 4px solid #333; border-top: 4px solid #E50914; border-radius: 50%;
            width: 40px; height: 40px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Admin Table */
        .admin-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .admin-table th { text-align: left; padding: 12px; color: #888; border-bottom: 2px solid #333; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em; }
        .admin-table td { padding: 12px; border-bottom: 1px solid #222; vertical-align: middle; }
        .admin-table tr:hover { background-color: #1f1f1f; }
        
        /* Phases */
        .phase-container { display: none; }
        .phase-active { display: block; animation: fadeIn 0.5s ease-in-out; }

        /* Toast Notification */
        .toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 4px;
            padding: 16px;
            position: fixed;
            z-index: 100;
            right: 30px;
            bottom: 30px;
            font-size: 17px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            transform: translateY(100%);
            transition: transform 0.3s ease, visibility 0.3s;
            border-left: 5px solid #E50914;
        }
        .toast.show {
            visibility: visible;
            transform: translateY(0);
        }
        .toast.success { border-left-color: #39ff14; }
        .toast.error { border-left-color: #ff4d4d; }
    </style>
</head>
<body class="antialiased selection:bg-netflix-red selection:text-white">

    <!-- Navbar -->
    <nav class="fixed top-0 w-full z-50 bg-gradient-to-b from-black/90 to-transparent backdrop-blur-sm px-8 py-4 flex justify-between items-center transition-all duration-300 border-b border-white/5" id="navbar">
        <div class="flex items-center gap-8">
            <h1 id="siteBrand" class="text-3xl font-black text-netflix-red tracking-tighter cursor-pointer hover:scale-105 transition" onclick="app.router('home')">STUDYFLIX</h1>
            <ul class="hidden md:flex gap-6 text-sm font-medium text-gray-300">
                <li class="hover:text-white cursor-pointer transition font-bold" onclick="app.router('home')">Início</li>
                <li class="hover:text-white cursor-pointer transition font-bold text-gray-500 cursor-not-allowed">Minha Lista</li>
            </ul>
        </div>
        <div class="flex items-center gap-4">
            <button id="adminBtn" class="hidden flex items-center gap-2 text-neon-cyan border border-neon-cyan/50 bg-neon-cyan/10 px-3 py-1.5 rounded hover:bg-neon-cyan hover:text-black transition text-xs font-bold uppercase tracking-wider" onclick="app.router('admin')">
                <i class="fas fa-cog"></i> CMS Admin
            </button>
            <div id="authContainer">
                <!-- Injected via JS -->
            </div>
        </div>
    </nav>

    <!-- App Container -->
    <main id="app" class="pt-28 min-h-screen px-4 md:px-12 pb-12 relative">
        <div class="flex flex-col items-center justify-center mt-20 gap-4">
            <div class="loader"></div>
            <p class="text-gray-500 text-sm animate-pulse">Carregando sistema...</p>
        </div>
    </main>

    <!-- Modal de Login -->
    <div id="loginModal" class="fixed inset-0 bg-black/90 hidden z-[60] flex items-center justify-center backdrop-blur-md transition-opacity duration-300">
        <div class="bg-[#181818] p-8 rounded-lg border border-gray-700 w-full max-w-md relative shadow-2xl shadow-black">
            <button onclick="authManager.toggleModal(false)" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl transition">&times;</button>
            
            <h2 class="text-3xl font-bold mb-8 text-white text-center">Acessar Plataforma</h2>
            
            <form onsubmit="return false;" class="space-y-5">
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1">E-mail</label>
                    <input type="email" id="emailInput" placeholder="admin@userpro.com" class="w-full p-3 bg-[#333] text-white rounded border border-transparent focus:border-gray-500 focus:bg-[#444] focus:outline-none transition">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Senha</label>
                    <input type="password" id="passInput" placeholder="••••••••" class="w-full p-3 bg-[#333] text-white rounded border border-transparent focus:border-gray-500 focus:bg-[#444] focus:outline-none transition">
                </div>
                
                <div class="flex gap-3 pt-4">
                    <button id="btnLogin" onclick="authManager.handleLogin()" class="flex-1 bg-netflix-red text-white font-bold py-3 rounded hover:bg-red-700 transition active:scale-95 disabled:opacity-50 disabled:cursor-wait">
                        Entrar
                    </button>
                    <button id="btnRegister" onclick="authManager.handleRegister()" class="flex-1 border border-gray-500 text-gray-300 font-bold py-3 rounded hover:border-white hover:text-white hover:bg-white/10 transition active:scale-95 disabled:opacity-50 disabled:cursor-wait">
                        Cadastrar
                    </button>
                </div>
            </form>
            <p class="text-xs text-gray-500 text-center mt-6">
                Para gerenciar o conteúdo, faça login com um e-mail 
                <span class="text-neon-cyan font-mono">@userpro.com</span>
            </p>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <div class="flex items-center gap-3">
            <i id="toastIcon" class="fas fa-info-circle"></i>
            <span id="toastMsg" class="font-bold">Notificação</span>
        </div>
    </div>

    <!-- Scripts Modulares -->
    <script type="module">
        // ==========================================
        // 1. CONFIGURAÇÃO E IMPORTS
        // ==========================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, getDoc, updateDoc, setDoc, query, where, orderBy, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

        // Configuração Hardcoded (Para fins de demonstração)
        const firebaseConfig = {
            apiKey: "AIzaSyC38VXjnYskoAx5SLF6n3PiEgnaRtz4IJ0",
            authDomain: "studyflix53.firebaseapp.com",
            projectId: "studyflix53",
            storageBucket: "studyflix53.firebasestorage.app",
            messagingSenderId: "799853597162",
            appId: "1:799853597162:web:179f1450c419157d62a293"
        };

        const appId = "studyflix53";
        
        // Inicialização Services
        console.log("[INIT] Inicializando Firebase...");
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Referências Seguras
        const getColRef = (colName) => collection(db, 'artifacts', appId, 'public', 'data', colName);
        const getDocRef = (colName, docId) => doc(db, 'artifacts', appId, 'public', 'data', colName, docId);
        const getSettingsRef = () => doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global');
        const getUserRef = (userId, subCol, docId) => doc(db, 'artifacts', appId, 'users', userId, subCol, docId);

        // ==========================================
        // 2. UTILITÁRIOS E SEGURANÇA
        // ==========================================
        
        // Estado Global Reativo
        const state = {
            user: null,
            isAdmin: false,
            currentView: 'home',
            settings: { siteName: "StudyFlix", welcomeMessage: "Aprenda Sem Limites.", favicon: "" },
            editingId: null,
            quill: null
        };

        const utils = {
            // Sistema de Notificação Visual Robusto
            showToast: (msg, type = 'info') => {
                const toast = document.getElementById('toast');
                const msgEl = document.getElementById('toastMsg');
                const iconEl = document.getElementById('toastIcon');
                
                msgEl.innerText = msg;
                toast.className = `toast show ${type}`;
                
                // Ícones dinâmicos
                if(type === 'success') iconEl.className = 'fas fa-check-circle';
                else if(type === 'error') iconEl.className = 'fas fa-exclamation-triangle';
                else iconEl.className = 'fas fa-info-circle';

                console.log(`[TOAST] [${type.toUpperCase()}] ${msg}`);

                // Auto-hide
                if (window.toastTimeout) clearTimeout(window.toastTimeout);
                window.toastTimeout = setTimeout(() => {
                    toast.classList.remove('show');
                }, 4000);
            },

            // Regex validada para YouTube
            getYouTubeID: (url) => {
                if (!url) return null;
                const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
                const match = url.match(regExp);
                return (match && match[2].length === 11) ? match[2] : null;
            },

            stripHtml: (html) => {
                const tmp = document.createElement("DIV");
                tmp.innerHTML = html;
                return tmp.textContent || tmp.innerText || "";
            },

            formatError: (code) => {
                const errors = {
                    'auth/invalid-email': 'E-mail inválido.',
                    'auth/user-not-found': 'Usuário não encontrado.',
                    'auth/wrong-password': 'Senha incorreta.',
                    'auth/email-already-in-use': 'E-mail já cadastrado.',
                    'permission-denied': 'Permissão negada (Firebase Security Rules).',
                    'storage/unauthorized': 'Sem permissão para upload.',
                    'auth/admin-restricted-operation': 'Login anônimo desativado. Use E-mail/Senha.'
                };
                return errors[code] || `Erro desconhecido: ${code}`;
            }
        };

        // WRAPPER DE SEGURANÇA (Pilar 1: Debugging & Tratamento de Erro)
        // Envolve qualquer ação async, gerencia estado de loading do botão e captura erros
        async function safeAction(btnId, actionName, asyncFn) {
            const btn = document.getElementById(btnId);
            let originalText = "";
            
            if (btn) {
                originalText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Processando...`;
            }

            console.log(`[ACTION START] ${actionName}`);

            try {
                await asyncFn();
                console.log(`[ACTION SUCCESS] ${actionName}`);
            } catch (error) {
                console.error(`[ACTION ERROR] ${actionName}:`, error);
                utils.showToast(utils.formatError(error.code) || error.message, 'error');
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            }
        }

        // ==========================================
        // 3. LÓGICA DE APLICAÇÃO (CORE)
        // ==========================================

        const mainApp = {
            init: async () => {
                // Carregar configurações globais
                try {
                    const snap = await getDoc(getSettingsRef());
                    if (snap.exists()) {
                        state.settings = { ...state.settings, ...snap.data() };
                        console.log("[CONFIG] Configurações carregadas:", state.settings);
                    }
                    mainApp.applySettings();
                } catch (e) {
                    console.warn("[CONFIG] Usando defaults (primeira execução).");
                }
            },

            applySettings: () => {
                document.title = state.settings.siteName;
                const brand = document.getElementById('siteBrand');
                if (brand) brand.innerText = state.settings.siteName.toUpperCase();
                
                const favicon = document.getElementById('favicon');
                if (state.settings.favicon && favicon) favicon.href = state.settings.favicon;
            },

            router: (view, params = null) => {
                console.log(`[ROUTER] Navegando para: ${view}`);
                state.currentView = view;
                const container = document.getElementById('app');
                window.speechSynthesis.cancel();
                
                if (view === 'home') mainApp.renderHome(container);
                else if (view === 'player') mainApp.renderPlayer(container, params);
                else if (view === 'admin') adminManager.init(container);
            },

            // RENDERIZAÇÃO HOME
            renderHome: async (container) => {
                container.innerHTML = `<div class="flex flex-col items-center mt-20"><div class="loader"></div><p class="text-gray-500 mt-4">Carregando catálogo...</p></div>`;
                
                // VERIFICAÇÃO DE SEGURANÇA ANTES DO FETCH
                if (!state.user) {
                    container.innerHTML = `
                        <div class="flex flex-col items-center justify-center min-h-[50vh] text-center animate-fade-in p-6">
                            <h1 class="text-5xl md:text-7xl font-black mb-6 text-white drop-shadow-lg">Bem-vindo ao <span class="text-netflix-red">StudyFlix</span></h1>
                            <p class="text-xl text-gray-400 max-w-2xl mb-8">Sua plataforma de ensino personalizada. Para acessar o conteúdo exclusivo, é necessário realizar o login.</p>
                            <button onclick="authManager.toggleModal(true)" class="bg-netflix-red text-white px-8 py-4 rounded text-xl font-bold hover:bg-red-700 transition shadow-lg shadow-red-900/40 transform hover:scale-105">
                                <i class="fas fa-sign-in-alt mr-2"></i> Acessar Plataforma
                            </button>
                            <p class="text-sm text-gray-600 mt-8 max-w-md">Nota: Devido às configurações de segurança do banco de dados, o acesso anônimo está desabilitado. Por favor, crie uma conta ou faça login.</p>
                        </div>
                    `;
                    return;
                }

                try {
                    // Fetch Paralelo para performance
                    const [subSnap, unitSnap, lessonSnap] = await Promise.all([
                        getDocs(getColRef("subjects")),
                        getDocs(getColRef("units")),
                        getDocs(getColRef("lessons"))
                    ]);

                    let html = `
                        <div class="mb-10 animate-fade-in relative z-10">
                            <h1 class="text-5xl md:text-7xl font-black mb-4 text-white drop-shadow-lg">${state.settings.welcomeMessage}</h1>
                            <p class="text-xl text-gray-400 max-w-2xl">Sua plataforma de ensino personalizada.</p>
                        </div>
                    `;

                    if (subSnap.empty) {
                        html += `
                            <div class="border border-gray-700 bg-gray-800/50 p-8 rounded text-center max-w-lg mx-auto mt-10">
                                <i class="fas fa-film text-4xl text-gray-600 mb-4"></i>
                                <h3 class="text-xl font-bold text-white">Catálogo Vazio</h3>
                                <p class="text-gray-400 mt-2">Acesse o CMS Admin para adicionar conteúdo.</p>
                            </div>
                        `;
                    }

                    // Loop de Matérias
                    subSnap.forEach(sub => {
                        html += `
                            <div class="mt-12 mb-4 animate-fade-in">
                                <div class="flex items-center gap-4 group cursor-pointer w-fit" onclick="window.startSeries('${sub.id}')">
                                    <h2 class="text-2xl font-bold text-white group-hover:text-neon-cyan transition">${sub.data().title}</h2>
                                    <span class="text-xs font-bold bg-netflix-red text-white px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition transform translate-x-[-10px] group-hover:translate-x-0">
                                        <i class="fas fa-play mr-1"></i> INICIAR JORNADA
                                    </span>
                                </div>
                            </div>
                        `;
                        
                        const subUnits = unitSnap.docs.filter(u => u.data().subjectId === sub.id);
                        
                        if(subUnits.length === 0) html += `<p class="text-gray-600 italic text-sm ml-4">Sem unidades cadastradas.</p>`;

                        // Loop de Unidades
                        subUnits.forEach(unit => {
                            html += `
                                <div class="mb-8 ml-4 border-l-2 border-gray-800 pl-4">
                                    <h3 class="text-gray-400 mb-3 text-xs font-bold uppercase tracking-widest flex items-center gap-2">
                                        <i class="fas fa-layer-group"></i> ${unit.data().title}
                                    </h3>
                                    <div class="scrolling-wrapper pb-4">
                            `;
                            
                            const unitLessons = lessonSnap.docs.filter(l => l.data().unitId === unit.id);
                            
                            if(unitLessons.length === 0) html += `<span class="text-gray-700 text-sm italic p-2">Em breve...</span>`;

                            // Loop de Aulas
                            unitLessons.forEach(lesson => {
                                const ytId = utils.getYouTubeID(lesson.data().videoUrl);
                                const thumb = ytId 
                                    ? `https://img.youtube.com/vi/${ytId}/mqdefault.jpg` 
                                    : 'https://placehold.co/300x169/333/999?text=Sem+Imagem';
                                
                                html += `
                                    <div class="card group" onclick="window.playLesson('${lesson.id}')">
                                        <div class="h-40 overflow-hidden rounded-t relative">
                                            <img src="${thumb}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition duration-500">
                                            <div class="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition">
                                                <i class="fas fa-play-circle text-5xl text-white drop-shadow-lg"></i>
                                            </div>
                                        </div>
                                        <div class="p-4 bg-[#181818]">
                                            <h4 class="text-white font-bold text-sm truncate">${lesson.data().title}</h4>
                                            <div class="flex justify-between items-center mt-2">
                                                <span class="text-[10px] text-gray-500 uppercase">Aula</span>
                                                <i class="fas fa-chevron-right text-gray-600 text-xs"></i>
                                            </div>
                                        </div>
                                    </div>`;
                            });
                            html += `</div></div>`;
                        });
                    });
                    container.innerHTML = html;
                    console.log("[HOME] Renderização concluída.");
                } catch (e) { 
                    console.error(e);
                    // Falha silenciosa para mostrar home vazia caso não tenha permissão ainda
                    if(e.code && e.code.includes('permission-denied')) {
                         container.innerHTML = `<div class="text-center mt-20 p-6 bg-gray-900 rounded max-w-md mx-auto border border-gray-800">
                            <i class="fas fa-lock text-4xl text-neon-cyan mb-4"></i><br>
                            <h3 class="text-white font-bold text-xl mb-2">Acesso Restrito</h3>
                            <p class="text-gray-400 mb-6">Faça login para visualizar o conteúdo.</p>
                            <button onclick="authManager.toggleModal(true)" class="bg-netflix-red text-white px-6 py-2 rounded font-bold hover:bg-red-700 transition">Fazer Login</button>
                         </div>`;
                    } else {
                        container.innerHTML = `<div class="text-center text-red-500 mt-20"><i class="fas fa-bug text-4xl mb-4"></i><br>Erro crítico ao carregar home.<br>${e.message}</div>`; 
                    }
                }
            },

            // LÓGICA DO PLAYER (State Machine)
            renderPlayer: async (container, lessonId) => {
                container.innerHTML = `<div class="flex justify-center mt-20"><div class="loader"></div></div>`;
                
                try {
                    const docSnap = await getDoc(getDocRef("lessons", lessonId));
                    if (!docSnap.exists()) return container.innerHTML = "<div class='text-center text-white mt-20'>Aula não encontrada.</div>";
                    
                    const data = docSnap.data();
                    const ytId = utils.getYouTubeID(data.videoUrl);
                    
                    // Prepara navegação (Next Lesson)
                    const allLessonsSnap = await getDocs(query(getColRef("lessons"), where("unitId", "==", data.unitId)));
                    const lessons = allLessonsSnap.docs.map(d => ({id: d.id, ...d.data()}));
                    // Sort simples por criação (idealmente ter um campo 'order')
                    lessons.sort((a,b) => a.createdAt.localeCompare(b.createdAt));
                    
                    const currentIndex = lessons.findIndex(l => l.id === lessonId);
                    const nextLessonId = (currentIndex < lessons.length - 1) ? lessons[currentIndex + 1].id : null;

                    // Globais de controle
                    window.currentPlayerData = { lessonId, nextLessonId, hasFile: !!data.fileUrl };

                    container.innerHTML = `
                        <div class="max-w-6xl mx-auto animate-fade-in relative min-h-[85vh] flex flex-col">
                            <!-- Header de Navegação -->
                            <div class="flex justify-between items-center mb-6 border-b border-gray-800 pb-4">
                                <button onclick="app.router('home')" class="text-gray-400 hover:text-white flex items-center gap-2 transition hover:-translate-x-1">
                                    <i class="fas fa-arrow-left"></i> Voltar ao Menu
                                </button>
                                <div class="text-right">
                                    <h2 class="text-white font-bold text-lg">${data.title}</h2>
                                    <span class="text-xs text-gray-500 uppercase tracking-widest">Aula ${currentIndex+1} de ${lessons.length}</span>
                                </div>
                            </div>

                            <!-- FASE 1: VÍDEO -->
                            <div id="phase1" class="phase-container phase-active w-full flex-1 flex flex-col justify-center">
                                <div class="video-container mx-auto shadow-2xl shadow-purple-900/10 w-full max-w-4xl">
                                    <div id="yt-player"></div>
                                </div>
                                <div class="mt-6 text-center">
                                    <p class="text-gray-400 animate-pulse text-sm"><i class="fas fa-eye"></i> Assista até o fim para liberar o material.</p>
                                    <!-- Bypass para dev/demo -->
                                    <button onclick="window.nextPhase(2)" class="mt-4 text-xs text-gray-600 hover:text-white underline">Pular Vídeo (Dev Mode)</button>
                                </div>
                            </div>

                            <!-- FASE 2: LEITURA -->
                            <div id="phase2" class="phase-container w-full text-center py-10">
                                <i class="fas fa-book-reader text-6xl text-neon-cyan mb-6 animate-bounce"></i>
                                <h2 class="text-4xl font-bold mb-4 text-white">Momento de Estudo</h2>
                                <p class="text-gray-400 mb-8 max-w-xl mx-auto">Revise o material complementar antes de prosseguir para o resumo final.</p>
                                
                                ${data.fileUrl ? `
                                    <a href="${data.fileUrl}" target="_blank" class="inline-flex items-center gap-3 bg-gray-800 border border-gray-600 text-white px-8 py-4 rounded-lg hover:bg-gray-700 hover:border-white transition transform hover:scale-105 shadow-lg mb-8">
                                        <i class="fas fa-file-pdf text-red-500 text-2xl"></i>
                                        <div class="text-left">
                                            <div class="font-bold">Abrir Material de Apoio</div>
                                            <div class="text-xs text-gray-400">Clique para visualizar</div>
                                        </div>
                                    </a>
                                ` : `
                                    <div class="bg-gray-800/50 p-4 rounded inline-block mb-8 border border-gray-700">
                                        <i class="fas fa-info-circle text-gray-500"></i> Nenhum anexo para esta aula.
                                    </div>
                                `}
                                
                                <div>
                                    <button onclick="window.nextPhase(3)" class="bg-neon-cyan text-black font-black px-10 py-4 rounded-full hover:bg-cyan-300 transition shadow-[0_0_20px_rgba(0,243,255,0.4)] flex items-center gap-3 mx-auto">
                                        CONCLUIR LEITURA <i class="fas fa-arrow-right"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- FASE 3: RESUMO E CONCLUSÃO -->
                            <div id="phase3" class="phase-container w-full py-10">
                                <div class="max-w-3xl mx-auto">
                                    <div class="flex items-center gap-4 mb-6">
                                        <div class="w-4 h-4 bg-red-500 rounded-full animate-pulse shadow-[0_0_10px_red]"></div>
                                        <h2 class="text-3xl font-bold text-white">Resumo Inteligente</h2>
                                    </div>
                                    
                                    <div class="bg-[#1a1a1a] p-8 rounded-xl border border-neon-purple/30 shadow-[0_0_40px_rgba(188,19,254,0.1)] relative overflow-hidden">
                                        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-neon-purple to-transparent opacity-50"></div>
                                        
                                        <div id="summaryText" class="prose prose-invert prose-lg text-gray-300 leading-relaxed min-h-[100px]">
                                            ${data.summary || "<p>Nenhum resumo disponível para leitura automática.</p>"}
                                        </div>
                                    </div>

                                    <div class="mt-8 text-center">
                                        <p class="text-sm text-gray-500 italic mb-4">O sistema finalizará a aula automaticamente após a leitura.</p>
                                        <button onclick="window.speechSynthesis.cancel(); window.finishLesson()" class="text-red-500 hover:text-white underline text-sm">Parar Áudio e Concluir Agora</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

                    // Init YouTube API
                    if (window.YT && window.YT.Player) {
                        new YT.Player('yt-player', {
                            height: '100%', width: '100%', videoId: ytId,
                            playerVars: { 'autoplay': 1, 'controls': 1, 'rel': 0 },
                            events: {
                                'onStateChange': (e) => {
                                    if (e.data === YT.PlayerState.ENDED) {
                                        console.log("[PLAYER] Vídeo finalizado.");
                                        window.nextPhase(2);
                                    }
                                }
                            }
                        });
                    }

                } catch (e) {
                    console.error(e);
                    container.innerHTML = `<div class="text-red-500 text-center mt-20">Erro ao carregar player: ${e.message}</div>`;
                }
            },
            
            // Auto-Roteamento
            startSeries: async (subjectId) => {
                utils.showToast("Localizando primeira aula...", "info");
                try {
                    const unitsSnap = await getDocs(query(getColRef("units"), where("subjectId", "==", subjectId)));
                    if(unitsSnap.empty) throw new Error("Matéria sem unidades.");
                    
                    // Pega primeira unidade
                    const firstUnit = unitsSnap.docs[0]; // Simplificado (deveria ordenar)
                    
                    const lessonSnap = await getDocs(query(getColRef("lessons"), where("unitId", "==", firstUnit.id)));
                    if(lessonSnap.empty) throw new Error("Unidade sem aulas.");
                    
                    // Pega primeira aula
                    const lessons = lessonSnap.docs.map(d => ({id:d.id, ...d.data()})).sort((a,b) => a.createdAt.localeCompare(b.createdAt));
                    
                    mainApp.router('player', lessons[0].id);

                } catch (error) {
                    utils.showToast(error.message, 'error');
                }
            }
        };

        // ==========================================
        // 4. ADMINISTRAÇÃO & CMS (CORREÇÃO CRÍTICA)
        // ==========================================

        const adminManager = {
            init: (container) => {
                if (!state.isAdmin) return mainApp.router('home');
                
                container.innerHTML = `
                    <div class="max-w-7xl mx-auto animate-fade-in">
                        <header class="mb-8 flex flex-col md:flex-row justify-between items-end border-b border-gray-800 pb-6 gap-4">
                            <div>
                                <h2 class="text-4xl font-black text-white mb-2">CMS <span class="text-neon-cyan">ADMIN</span></h2>
                                <p class="text-gray-400">Gerencie todo o conteúdo da plataforma em tempo real.</p>
                            </div>
                            <div class="flex gap-2 bg-gray-900 p-1 rounded-lg border border-gray-700">
                                <button onclick="window.renderAdminTab('settings')" class="tab-btn px-4 py-2 text-sm font-bold text-gray-400 hover:text-white rounded hover:bg-gray-800 transition">Configurações</button>
                                <button onclick="window.renderAdminTab('subject')" class="tab-btn px-4 py-2 text-sm font-bold text-gray-400 hover:text-white rounded hover:bg-gray-800 transition">Matérias</button>
                                <button onclick="window.renderAdminTab('unit')" class="tab-btn px-4 py-2 text-sm font-bold text-gray-400 hover:text-white rounded hover:bg-gray-800 transition">Unidades</button>
                                <button onclick="window.renderAdminTab('lesson')" class="tab-btn px-4 py-2 text-sm font-bold text-gray-400 hover:text-white rounded hover:bg-gray-800 transition">Aulas</button>
                            </div>
                        </header>
                        <div id="adminContent" class="bg-[#181818] border border-gray-800 rounded-xl p-6 min-h-[500px] relative shadow-2xl">
                            <!-- Conteúdo injetado via JS -->
                        </div>
                    </div>
                `;
                window.renderAdminTab('settings');
            },

            renderTab: async (type) => {
                const content = document.getElementById('adminContent');
                content.innerHTML = '<div class="absolute inset-0 flex items-center justify-center bg-[#181818] z-10"><div class="loader"></div></div>';
                
                state.editingId = null; // Reset estado de edição
                
                // Highlight Tab
                document.querySelectorAll('.tab-btn').forEach(b => {
                    if(b.innerText.toLowerCase().includes(type === 'subject' ? 'matérias' : type === 'unit' ? 'unidades' : type === 'lesson' ? 'aulas' : 'configurações')) {
                        b.classList.add('bg-neon-cyan', 'text-black');
                        b.classList.remove('text-gray-400', 'hover:bg-gray-800');
                    } else {
                        b.classList.remove('bg-neon-cyan', 'text-black');
                        b.classList.add('text-gray-400');
                    }
                });

                try {
                    if (type === 'settings') {
                        content.innerHTML = `
                            <h3 class="text-xl font-bold text-white mb-6 flex items-center gap-2"><i class="fas fa-sliders-h"></i> Parâmetros Globais</h3>
                            <form onsubmit="return false;" class="max-w-2xl space-y-6">
                                <div>
                                    <label class="block text-gray-500 text-xs font-bold uppercase mb-2">Nome da Plataforma</label>
                                    <input type="text" id="siteName" value="${state.settings.siteName}" class="w-full p-3 bg-black border border-gray-700 rounded text-white focus:border-neon-cyan focus:outline-none transition">
                                </div>
                                <div>
                                    <label class="block text-gray-500 text-xs font-bold uppercase mb-2">Mensagem de Boas-vindas</label>
                                    <input type="text" id="welcomeMsg" value="${state.settings.welcomeMessage}" class="w-full p-3 bg-black border border-gray-700 rounded text-white focus:border-neon-cyan focus:outline-none transition">
                                </div>
                                <div>
                                    <label class="block text-gray-500 text-xs font-bold uppercase mb-2">URL do Favicon</label>
                                    <input type="url" id="faviconUrl" value="${state.settings.favicon || ''}" class="w-full p-3 bg-black border border-gray-700 rounded text-white focus:border-neon-cyan focus:outline-none transition">
                                </div>
                                <button id="btnSettings" onclick="window.saveSettings()" class="bg-neon-purple text-white px-6 py-3 rounded font-bold hover:bg-purple-700 transition flex items-center gap-2">
                                    <i class="fas fa-save"></i> Salvar Alterações
                                </button>
                            </form>
                        `;
                    } else {
                        // GENERIC CRUD UI
                        const collectionName = type + 's';
                        const snapshot = await getDocs(getColRef(collectionName));
                        const items = snapshot.docs.map(d => ({id: d.id, ...d.data()}));

                        let formHtml = '';
                        
                        // Form Builder Baseado no Tipo
                        if (type === 'subject') {
                            formHtml = `
                                <div class="grid gap-4">
                                    <input type="text" id="title" placeholder="Nome da Matéria (Ex: Matemática)" class="w-full p-3 bg-black border border-gray-700 rounded text-white">
                                </div>`;
                        } else if (type === 'unit') {
                            const subjects = await getDocs(getColRef('subjects'));
                            const opts = subjects.docs.map(d => `<option value="${d.id}">${d.data().title}</option>`).join('');
                            formHtml = `
                                <div class="grid gap-4">
                                    <select id="subjectId" class="w-full p-3 bg-black border border-gray-700 rounded text-white">${opts || '<option>Crie uma matéria primeiro</option>'}</select>
                                    <input type="text" id="title" placeholder="Nome da Unidade (Ex: Álgebra I)" class="w-full p-3 bg-black border border-gray-700 rounded text-white">
                                </div>`;
                        } else if (type === 'lesson') {
                            const units = await getDocs(getColRef('units'));
                            const opts = units.docs.map(d => `<option value="${d.id}">${d.data().title}</option>`).join('');
                            formHtml = `
                                <div class="grid gap-4">
                                    <select id="unitId" class="w-full p-3 bg-black border border-gray-700 rounded text-white">${opts || '<option>Crie uma unidade primeiro</option>'}</select>
                                    <input type="text" id="title" placeholder="Título da Aula" class="w-full p-3 bg-black border border-gray-700 rounded text-white">
                                    <input type="url" id="videoUrl" placeholder="Link YouTube (Qualquer formato)" class="w-full p-3 bg-black border border-gray-700 rounded text-white">
                                    
                                    <div class="bg-gray-900 rounded border border-gray-700">
                                        <div id="editor" class="h-40 text-gray-300"></div>
                                    </div>

                                    <div class="border border-dashed border-gray-600 rounded p-4 text-center hover:bg-gray-800 transition relative">
                                        <input type="file" id="fileInput" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                                        <div id="fileLabel" class="text-gray-400 text-sm"><i class="fas fa-cloud-upload-alt mr-2"></i> Arraste PDF ou Áudio (Opcional)</div>
                                    </div>
                                </div>`;
                        }

                        content.innerHTML = `
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                <!-- Coluna Formulário -->
                                <div class="lg:col-span-1 border-r border-gray-800 pr-6">
                                    <h3 class="text-xl font-bold text-white mb-4" id="formHeader">Novo Item</h3>
                                    <form onsubmit="return false;" class="space-y-4">
                                        ${formHtml}
                                        <div class="flex gap-2 pt-2">
                                            <button id="btnSave" onclick="window.handleSave('${type}')" class="flex-1 bg-neon-cyan text-black font-bold py-3 rounded hover:bg-cyan-300 transition">
                                                <i class="fas fa-plus-circle"></i> Criar
                                            </button>
                                            <button id="btnCancel" onclick="window.renderAdminTab('${type}')" class="hidden px-4 text-red-500 font-bold hover:bg-red-500/10 rounded">
                                                Cancelar
                                            </button>
                                        </div>
                                    </form>
                                </div>

                                <!-- Coluna Lista -->
                                <div class="lg:col-span-2">
                                    <h3 class="text-xl font-bold text-gray-400 mb-4 flex justify-between">
                                        Registros <span class="text-xs bg-gray-800 px-2 py-1 rounded">${items.length}</span>
                                    </h3>
                                    <div class="overflow-x-auto max-h-[600px] overflow-y-auto rounded border border-gray-800">
                                        <table class="admin-table">
                                            <thead>
                                                <tr>
                                                    <th class="pl-4">Título</th>
                                                    <th>ID</th>
                                                    <th class="text-right pr-4">Ações</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${items.map(item => `
                                                    <tr>
                                                        <td class="pl-4 font-medium text-white">${item.title}</td>
                                                        <td class="text-gray-600 font-mono text-xs">${item.id.substring(0,6)}...</td>
                                                        <td class="text-right pr-4">
                                                            <button onclick="window.editItem('${type}', '${item.id}')" class="text-neon-cyan hover:bg-cyan-900/30 p-2 rounded transition mr-1" title="Editar"><i class="fas fa-edit"></i></button>
                                                            <button onclick="window.deleteItem('${type}', '${item.id}')" class="text-red-500 hover:bg-red-900/30 p-2 rounded transition" title="Excluir"><i class="fas fa-trash"></i></button>
                                                        </td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                        ${items.length === 0 ? '<div class="p-8 text-center text-gray-600">Nenhum item encontrado.</div>' : ''}
                                    </div>
                                </div>
                            </div>
                        `;

                        // Init Quill APÓS o DOM existir (Critical Fix)
                        if (type === 'lesson') {
                            state.quill = new Quill('#editor', {
                                theme: 'snow',
                                placeholder: 'Escreva o resumo da aula aqui...',
                                modules: { toolbar: [['bold', 'italic', 'underline'], [{ 'header': 1 }, { 'header': 2 }], ['code-block']] }
                            });
                            
                            // File Input listener para feedback visual
                            document.getElementById('fileInput').addEventListener('change', (e) => {
                                const label = document.getElementById('fileLabel');
                                if (e.target.files[0]) {
                                    label.innerHTML = `<span class="text-neon-cyan"><i class="fas fa-check"></i> ${e.target.files[0].name}</span>`;
                                }
                            });
                        }
                    }
                } catch (e) {
                    console.error(e);
                    utils.showToast("Erro ao carregar aba Admin.", "error");
                }
            },

            // Create / Update Logic com Debug
            handleSave: async (type) => {
                await safeAction('btnSave', `Salvar ${type}`, async () => {
                    const collectionName = type + 's';
                    const isEdit = !!state.editingId;
                    
                    // Validação Básica
                    const titleEl = document.getElementById('title');
                    if (!titleEl || !titleEl.value.trim()) throw new Error("O campo Título é obrigatório.");

                    const data = {
                        title: titleEl.value,
                        updatedAt: new Date().toISOString()
                    };

                    if (!isEdit) data.createdAt = new Date().toISOString();

                    // Validações Específicas
                    if (type === 'unit') {
                        data.subjectId = document.getElementById('subjectId').value;
                    }
                    else if (type === 'lesson') {
                        data.unitId = document.getElementById('unitId').value;
                        const videoUrl = document.getElementById('videoUrl').value;
                        if (!utils.getYouTubeID(videoUrl)) throw new Error("URL do YouTube inválida.");
                        data.videoUrl = videoUrl;
                        
                        // Quill Content
                        if (state.quill) {
                            data.summary = state.quill.root.innerHTML;
                        }

                        // Upload de Arquivo (Storage)
                        const fileInput = document.getElementById('fileInput');
                        if (fileInput && fileInput.files[0]) {
                            const file = fileInput.files[0];
                            console.log(`[UPLOAD] Iniciando upload de: ${file.name}`);
                            
                            // Visual feedback
                            document.getElementById('fileLabel').innerText = "Enviando arquivo... (Aguarde)";
                            
                            const fileRef = ref(storage, `materials/${Date.now()}_${file.name}`);
                            await uploadBytes(fileRef, file);
                            data.fileUrl = await getDownloadURL(fileRef);
                            
                            console.log(`[UPLOAD] Sucesso. URL: ${data.fileUrl}`);
                        }
                    }

                    // Firestore Action
                    if (isEdit) {
                        await updateDoc(getDocRef(collectionName, state.editingId), data);
                        utils.showToast("Item atualizado com sucesso!", "success");
                    } else {
                        await addDoc(getColRef(collectionName), data);
                        utils.showToast("Item criado com sucesso!", "success");
                    }

                    // Reload UI
                    window.renderAdminTab(type);
                });
            },

            editItem: async (type, id) => {
                state.editingId = id;
                const collectionName = type + 's';
                
                // Feedback visual de carregamento
                utils.showToast("Carregando dados para edição...", "info");

                try {
                    const docSnap = await getDoc(getDocRef(collectionName, id));
                    if (!docSnap.exists()) throw new Error("Item não encontrado.");
                    const data = docSnap.data();

                    // Preenche campos
                    document.getElementById('title').value = data.title;
                    if (type === 'unit') document.getElementById('subjectId').value = data.subjectId;
                    if (type === 'lesson') {
                        document.getElementById('unitId').value = data.unitId;
                        document.getElementById('videoUrl').value = data.videoUrl;
                        if (state.quill) state.quill.root.innerHTML = data.summary || "";
                        if (data.fileUrl) document.getElementById('fileLabel').innerText = "Arquivo já anexado (envie outro para substituir)";
                    }

                    // Muda estado do form
                    document.getElementById('formHeader').innerText = "Editando Item";
                    const btnSave = document.getElementById('btnSave');
                    btnSave.innerHTML = `<i class="fas fa-save"></i> Atualizar`;
                    btnSave.classList.replace('bg-neon-cyan', 'bg-neon-green');
                    document.getElementById('btnCancel').classList.remove('hidden');

                } catch (e) {
                    utils.showToast(e.message, 'error');
                }
            },

            deleteItem: async (type, id) => {
                if (!confirm("Tem certeza? Esta ação é irreversível.")) return;
                
                await safeAction(null, `Excluir ${type}`, async () => {
                    await deleteDoc(getDocRef(type + 's', id));
                    utils.showToast("Item excluído permanentemente.", "success");
                    window.renderAdminTab(type);
                });
            },

            saveSettings: async () => {
                await safeAction('btnSettings', 'Salvar Configurações', async () => {
                    const settings = {
                        siteName: document.getElementById('siteName').value,
                        welcomeMessage: document.getElementById('welcomeMsg').value,
                        favicon: document.getElementById('faviconUrl').value
                    };
                    await setDoc(getSettingsRef(), settings);
                    state.settings = settings;
                    mainApp.applySettings();
                    utils.showToast("Configurações aplicadas!", "success");
                });
            }
        };

        // ==========================================
        // 5. BINDINGS E EVENTOS GLOBAIS
        // ==========================================

        window.app = mainApp;
        
        // Auth Bindings
        window.authManager = {
            toggleModal: (show) => {
                const modal = document.getElementById('loginModal');
                if (show) modal.classList.remove('hidden');
                else modal.classList.add('hidden');
            },
            handleLogin: async () => {
                const email = document.getElementById('emailInput').value;
                const pass = document.getElementById('passInput').value;
                await safeAction('btnLogin', 'Login', async () => {
                    if (!email || !pass) throw new Error("Preencha todos os campos.");
                    await signInWithEmailAndPassword(auth, email, pass);
                    window.authManager.toggleModal(false);
                    utils.showToast("Login efetuado com sucesso!", "success");
                });
            },
            handleRegister: async () => {
                const email = document.getElementById('emailInput').value;
                const pass = document.getElementById('passInput').value;
                await safeAction('btnRegister', 'Cadastro', async () => {
                    if (!email || !pass) throw new Error("Preencha todos os campos.");
                    await createUserWithEmailAndPassword(auth, email, pass);
                    window.authManager.toggleModal(false);
                    utils.showToast("Conta criada! Bem-vindo.", "success");
                });
            },
            logout: async () => {
                await signOut(auth);
                window.location.reload();
            }
        };

        // Admin Bindings
        window.renderAdminTab = adminManager.renderTab;
        window.saveSettings = adminManager.saveSettings;
        window.handleSave = adminManager.handleSave;
        window.editItem = adminManager.editItem;
        window.deleteItem = adminManager.deleteItem;
        
        // Navigation Bindings
        window.startSeries = mainApp.startSeries;
        window.playLesson = (id) => mainApp.router('player', id);

        // Player Phase Control
        window.nextPhase = (phase) => {
            // Remove active class
            document.querySelectorAll('.phase-container').forEach(el => el.classList.remove('phase-active'));
            
            // Logic Phase 2 (Leitura)
            if (phase === 2 && !window.currentPlayerData.hasFile) {
                console.log("[PLAYER] Sem arquivo, pulando para Fase 3.");
                return window.nextPhase(3);
            }

            // Logic Phase 3 (Resumo)
            if (phase === 3) {
                const text = utils.stripHtml(document.getElementById('summaryText').innerHTML);
                if (text && text.trim().length > 10) {
                    console.log("[TTS] Iniciando leitura...");
                    const u = new SpeechSynthesisUtterance(text);
                    u.lang = 'pt-BR';
                    u.rate = 1.1;
                    u.onend = window.finishLesson;
                    speechSynthesis.speak(u);
                } else {
                    console.log("[TTS] Texto insuficiente, finalizando.");
                    setTimeout(window.finishLesson, 2000);
                }
            }

            // Activate new phase
            const nextEl = document.getElementById(`phase${phase}`);
            if (nextEl) nextEl.classList.add('phase-active');
        };

        window.finishLesson = async () => {
            utils.showToast("✅ Aula Concluída!", "success");
            
            if (state.user && !state.user.isAnonymous) {
                try {
                    const ref = getUserRef(state.user.uid, "progress", window.currentPlayerData.lessonId);
                    await setDoc(ref, { concluido: true, date: new Date().toISOString() });
                } catch(e) { console.error("[PROGRESS] Erro ao salvar:", e); }
            }

            if (window.currentPlayerData.nextLessonId) {
                utils.showToast("Próxima aula em 3s...", "info");
                setTimeout(() => mainApp.router('player', window.currentPlayerData.nextLessonId), 3000);
            } else {
                utils.showToast("Módulo finalizado!", "success");
                setTimeout(() => mainApp.router('home'), 3000);
            }
        };

        // Inicialização do Auth Listener
        onAuthStateChanged(auth, (user) => {
            state.user = user;
            const container = document.getElementById('authContainer');
            
            if (user) {
                console.log(`[AUTH] Usuário logado: ${user.email} (Anon: ${user.isAnonymous})`);
                
                if (user.isAnonymous) {
                    state.isAdmin = false;
                    container.innerHTML = `<button onclick="authManager.toggleModal(true)" class="bg-netflix-red text-white px-4 py-2 rounded font-bold hover:bg-red-700 transition shadow-lg shadow-red-900/20">Entrar / Cadastrar</button>`;
                } else {
                    // Check Admin
                    state.isAdmin = user.email && user.email.endsWith('@userpro.com');
                    
                    if (state.isAdmin) {
                        document.getElementById('adminBtn').classList.remove('hidden');
                        utils.showToast(`Modo Admin Ativo: ${user.email}`, "success");
                    } else {
                        document.getElementById('adminBtn').classList.add('hidden');
                    }

                    container.innerHTML = `
                        <div class="flex items-center gap-3 bg-black/40 px-3 py-1.5 rounded-full border border-gray-700">
                            <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                            <span class="text-xs text-gray-300 hidden md:block">${user.email.split('@')[0]}</span>
                            <button onclick="authManager.logout()" class="text-xs text-gray-400 hover:text-white border-l border-gray-600 pl-3 ml-1">Sair</button>
                        </div>
                    `;
                }

                // Carrega o app se estiver na tela inicial
                if (state.currentView === 'home') mainApp.init().then(() => mainApp.router('home'));

            } else {
                console.log("[AUTH] Nenhum usuário. Tentando login anônimo...");
                signInAnonymously(auth).catch(e => {
                    const ignoredErrors = ['auth/admin-restricted-operation', 'auth/operation-not-allowed'];
                    if (ignoredErrors.includes(e.code)) {
                         console.warn("[AUTH] Login anônimo não habilitado. Exibindo opção de login manual.");
                         // Fallback visual silencioso
                         container.innerHTML = `<button onclick="authManager.toggleModal(true)" class="bg-netflix-red text-white px-4 py-2 rounded font-bold hover:bg-red-700 transition shadow-lg shadow-red-900/20">Entrar</button>`;
                         
                         // Se não tiver usuário, ainda tentamos renderizar a home, 
                         // mas se as regras do Firestore exigirem auth, vai dar erro lá.
                         // Vamos deixar renderizar e o erro de permissão do Firestore será pego pelo safeAction ou try/catch do renderHome.
                         if (state.currentView === 'home') mainApp.router('home'); 
                    } else {
                        console.error("[AUTH] Erro anônimo:", e);
                        container.innerHTML = `<button onclick="authManager.toggleModal(true)" class="bg-netflix-red text-white px-4 py-2 rounded font-bold">Entrar</button>`;
                    }
                });
            }
        });

    </script>
</body>
</html>
