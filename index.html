<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyFlix - Plataforma Robusta</title>
    <link id="favicon" rel="icon" type="image/x-icon" href="">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Quill.js (Editor de Texto Rico) -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

    <!-- YouTube IFrame API -->
    <script src="https://www.youtube.com/iframe_api"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Configura√ß√£o de Design System -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        netflix: {
                            black: '#141414',
                            dark: '#181818',
                            red: '#E50914',
                            hover: '#2F2F2F',
                            input: '#333'
                        },
                        neon: {
                            cyan: '#00f3ff',
                            purple: '#bc13fe',
                            green: '#39ff14',
                            error: '#ff4d4d'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-in-out',
                        'spin-slow': 'spin 3s linear infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700;900&display=swap');

        body {
            background-color: #141414;
            color: #e5e5e5;
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }

        /* Scrollbar Customizada */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #141414; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #E50914; }

        .scrolling-wrapper {
            display: flex; flex-wrap: nowrap; overflow-x: auto;
            -webkit-overflow-scrolling: touch; padding-bottom: 20px; scroll-behavior: smooth;
        }
        .scrolling-wrapper::-webkit-scrollbar { display: none; }
        
        /* Cards */
        .card {
            flex: 0 0 auto; width: 300px; margin-right: 15px;
            background: #181818; border-radius: 4px; position: relative; cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover { 
            transform: scale(1.05); 
            z-index: 10;
            box-shadow: 0 0 20px rgba(0,0,0,0.7);
        }

        /* Video Player Ratio */
        .video-container {
            position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;
            border-radius: 8px; border: 1px solid #333; background: black;
        }
        .video-container iframe, .video-container div { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        /* Quill Editor Dark Theme Fix */
        .ql-toolbar { background-color: #e5e5e5; border-radius: 8px 8px 0 0; }
        .ql-container { color: #e5e5e5; font-size: 16px; border-radius: 0 0 8px 8px; background-color: #2F2F2F; border: 1px solid #444; }
        .ql-editor.ql-blank::before { color: #aaa; font-style: italic; }
        
        /* Loading Spinner */
        .loader {
            border: 4px solid #333; border-top: 4px solid #E50914; border-radius: 50%;
            width: 40px; height: 40px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Admin Table */
        .admin-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .admin-table th { text-align: left; padding: 12px; color: #888; border-bottom: 2px solid #333; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em; }
        .admin-table td { padding: 12px; border-bottom: 1px solid #222; vertical-align: middle; }
        .admin-table tr:hover { background-color: #1f1f1f; }
        
        /* Phases */
        .phase-container { display: none; }
        .phase-active { display: block; animation: fadeIn 0.5s ease-in-out; }

        /* Toast Notification */
        .toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 4px;
            padding: 16px;
            position: fixed;
            z-index: 100;
            right: 30px;
            bottom: 30px;
            font-size: 17px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            transform: translateY(100%);
            transition: transform 0.3s ease, visibility 0.3s;
            border-left: 5px solid #E50914;
        }
        .toast.show {
            visibility: visible;
            transform: translateY(0);
        }
        .toast.success { border-left-color: #39ff14; }
        .toast.error { border-left-color: #ff4d4d; }

        /* Countdown Overlay */
        #countdownOverlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.9); z-index: 50;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
        }
    </style>
</head>
<body class="antialiased selection:bg-netflix-red selection:text-white">

    <!-- Navbar -->
    <nav class="fixed top-0 w-full z-50 bg-gradient-to-b from-black/90 to-transparent backdrop-blur-sm px-8 py-4 flex justify-between items-center transition-all duration-300 border-b border-white/5" id="navbar">
        <div class="flex items-center gap-8">
            <h1 id="siteBrand" class="text-3xl font-black text-netflix-red tracking-tighter cursor-pointer hover:scale-105 transition" onclick="app.router('home')">STUDYFLIX</h1>
            <ul class="hidden md:flex gap-6 text-sm font-medium text-gray-300">
                <li class="hover:text-white cursor-pointer transition font-bold" onclick="app.router('home')">In√≠cio</li>
                <li class="hover:text-white cursor-pointer transition font-bold text-gray-500 cursor-not-allowed">Minha Lista</li>
            </ul>
        </div>
        <div class="flex items-center gap-4">
            <button id="adminBtn" class="hidden flex items-center gap-2 text-neon-cyan border border-neon-cyan/50 bg-neon-cyan/10 px-3 py-1.5 rounded hover:bg-neon-cyan hover:text-black transition text-xs font-bold uppercase tracking-wider" onclick="app.router('admin')">
                <i class="fas fa-cog"></i> CMS Admin
            </button>
            <div id="authContainer">
                <!-- Injected via JS -->
            </div>
        </div>
    </nav>

    <!-- App Container -->
    <main id="app" class="pt-28 min-h-screen px-4 md:px-12 pb-12 relative">
        <div class="flex flex-col items-center justify-center mt-20 gap-4">
            <div class="loader"></div>
            <p class="text-gray-500 text-sm animate-pulse">Carregando sistema...</p>
        </div>
    </main>

    <!-- Modal de Login -->
    <div id="loginModal" class="fixed inset-0 bg-black/90 hidden z-[60] flex items-center justify-center backdrop-blur-md transition-opacity duration-300">
        <div class="bg-[#181818] p-8 rounded-lg border border-gray-700 w-full max-w-md relative shadow-2xl shadow-black">
            <button onclick="authManager.toggleModal(false)" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl transition">&times;</button>
            
            <h2 class="text-3xl font-bold mb-8 text-white text-center">Acessar Plataforma</h2>
            
            <form onsubmit="return false;" class="space-y-5">
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1">E-mail</label>
                    <input type="email" id="emailInput" placeholder="admin@userpro.com" class="w-full p-3 bg-[#333] text-white rounded border border-transparent focus:border-gray-500 focus:bg-[#444] focus:outline-none transition">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Senha</label>
                    <input type="password" id="passInput" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full p-3 bg-[#333] text-white rounded border border-transparent focus:border-gray-500 focus:bg-[#444] focus:outline-none transition">
                </div>
                
                <div class="flex gap-3 pt-4">
                    <button id="btnLogin" onclick="authManager.handleLogin()" class="flex-1 bg-netflix-red text-white font-bold py-3 rounded hover:bg-red-700 transition active:scale-95 disabled:opacity-50 disabled:cursor-wait">
                        Entrar
                    </button>
                    <button id="btnRegister" onclick="authManager.handleRegister()" class="flex-1 border border-gray-500 text-gray-300 font-bold py-3 rounded hover:border-white hover:text-white hover:bg-white/10 transition active:scale-95 disabled:opacity-50 disabled:cursor-wait">
                        Cadastrar
                    </button>
                </div>
            </form>
            <p class="text-xs text-gray-500 text-center mt-6">
                Para gerenciar o conte√∫do, fa√ßa login com um e-mail 
                <span class="text-neon-cyan font-mono">@userpro.com</span>
            </p>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <div class="flex items-center gap-3">
            <i id="toastIcon" class="fas fa-info-circle"></i>
            <span id="toastMsg" class="font-bold">Notifica√ß√£o</span>
        </div>
    </div>

    <!-- Scripts Modulares -->
    <script type="module">
        // ==========================================
        // 1. CONFIGURA√á√ÉO E IMPORTS
        // ==========================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, getDoc, updateDoc, setDoc, query, where, orderBy, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // Configura√ß√£o Hardcoded
        const firebaseConfig = {
            apiKey: "AIzaSyC38VXjnYskoAx5SLF6n3PiEgnaRtz4IJ0",
            authDomain: "studyflix53.firebaseapp.com",
            projectId: "studyflix53",
            storageBucket: "studyflix53.firebasestorage.app",
            messagingSenderId: "799853597162",
            appId: "1:799853597162:web:179f1450c419157d62a293"
        };

        const appId = "studyflix53";
        
        // Inicializa√ß√£o Services
        console.log("[INIT] Inicializando Firebase...");
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Refer√™ncias Seguras
        const getColRef = (colName) => collection(db, 'artifacts', appId, 'public', 'data', colName);
        const getDocRef = (colName, docId) => doc(db, 'artifacts', appId, 'public', 'data', colName, docId);
        const getSettingsRef = () => doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global');
        const getUserRef = (userId, subCol, docId) => doc(db, 'artifacts', appId, 'users', userId, subCol, docId);

        // ==========================================
        // 2. UTILIT√ÅRIOS E SEGURAN√áA
        // ==========================================
        
        const state = {
            user: null,
            isAdmin: false,
            currentView: 'home',
            settings: { siteName: "StudyFlix", welcomeMessage: "Aprenda Sem Limites.", favicon: "" },
            editingId: null,
            quill: null
        };

        const utils = {
            showToast: (msg, type = 'info') => {
                const toast = document.getElementById('toast');
                const msgEl = document.getElementById('toastMsg');
                const iconEl = document.getElementById('toastIcon');
                
                msgEl.innerText = msg;
                toast.className = `toast show ${type}`;
                
                if(type === 'success') iconEl.className = 'fas fa-check-circle';
                else if(type === 'error') iconEl.className = 'fas fa-exclamation-triangle';
                else iconEl.className = 'fas fa-info-circle';

                if (window.toastTimeout) clearTimeout(window.toastTimeout);
                window.toastTimeout = setTimeout(() => {
                    toast.classList.remove('show');
                }, 4000);
            },

            getYouTubeID: (url) => {
                if (!url) return null;
                const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
                const match = url.match(regExp);
                return (match && match[2].length === 11) ? match[2] : null;
            },

            stripHtml: (html) => {
                const tmp = document.createElement("DIV");
                tmp.innerHTML = html;
                return tmp.textContent || tmp.innerText || "";
            },

            formatError: (code) => {
                const errors = {
                    'auth/invalid-email': 'E-mail inv√°lido.',
                    'auth/user-not-found': 'Usu√°rio n√£o encontrado.',
                    'auth/wrong-password': 'Senha incorreta.',
                    'auth/email-already-in-use': 'E-mail j√° cadastrado.',
                    'permission-denied': 'Permiss√£o negada.',
                    'auth/admin-restricted-operation': 'Login an√¥nimo desativado.'
                };
                return errors[code] || `Erro: ${code}`;
            }
        };

        async function safeAction(btnId, actionName, asyncFn) {
            const btn = document.getElementById(btnId);
            let originalText = "";
            
            if (btn) {
                originalText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Processando...`;
            }

            try {
                await asyncFn();
            } catch (error) {
                console.error(`[ACTION ERROR] ${actionName}:`, error);
                utils.showToast(utils.formatError(error.code) || error.message, 'error');
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            }
        }

        // ==========================================
        // 3. L√ìGICA DE APLICA√á√ÉO (CORE)
        // ==========================================

        const mainApp = {
            init: async () => {
                try {
                    const snap = await getDoc(getSettingsRef());
                    if (snap.exists()) {
                        state.settings = { ...state.settings, ...snap.data() };
                    }
                    mainApp.applySettings();
                } catch (e) {
                    console.warn("[CONFIG] Usando defaults.");
                }
            },

            applySettings: () => {
                document.title = state.settings.siteName;
                const brand = document.getElementById('siteBrand');
                if (brand) brand.innerText = state.settings.siteName.toUpperCase();
                
                const favicon = document.getElementById('favicon');
                if (state.settings.favicon && favicon) favicon.href = state.settings.favicon;
            },

            router: (view, params = null) => {
                state.currentView = view;
                const container = document.getElementById('app');
                window.speechSynthesis.cancel();
                
                if (view === 'home') mainApp.renderHome(container);
                else if (view === 'player') mainApp.renderPlayer(container, params);
                else if (view === 'admin') adminManager.init(container);
            },

            renderHome: async (container) => {
                container.innerHTML = `<div class="flex flex-col items-center mt-20"><div class="loader"></div></div>`;
                
                if (!state.user) {
                    container.innerHTML = `
                        <div class="flex flex-col items-center justify-center min-h-[50vh] text-center animate-fade-in p-6">
                            <h1 class="text-5xl md:text-7xl font-black mb-6 text-white">Bem-vindo ao <span class="text-netflix-red">StudyFlix</span></h1>
                            <p class="text-xl text-gray-400 max-w-2xl mb-8">Fa√ßa login para continuar sua jornada de aprendizado.</p>
                            <button onclick="authManager.toggleModal(true)" class="bg-netflix-red text-white px-8 py-4 rounded text-xl font-bold hover:bg-red-700 transition">
                                <i class="fas fa-sign-in-alt mr-2"></i> Acessar Plataforma
                            </button>
                        </div>
                    `;
                    return;
                }

                try {
                    const [subSnap, unitSnap, lessonSnap] = await Promise.all([
                        getDocs(getColRef("subjects")),
                        getDocs(getColRef("units")),
                        getDocs(getColRef("lessons"))
                    ]);

                    let html = `
                        <div class="mb-10 animate-fade-in relative z-10">
                            <h1 class="text-5xl md:text-7xl font-black mb-4 text-white">${state.settings.welcomeMessage}</h1>
                            <p class="text-xl text-gray-400 max-w-2xl">Sua plataforma de ensino personalizada.</p>
                        </div>
                    `;

                    if (subSnap.empty) {
                        html += `<div class="text-center text-gray-500 mt-10">Cat√°logo Vazio. Acesse o CMS Admin.</div>`;
                    }

                    subSnap.forEach(sub => {
                        html += `
                            <div class="mt-12 mb-4 animate-fade-in">
                                <div class="flex items-center gap-4 group cursor-pointer w-fit" onclick="window.startSeries('${sub.id}')">
                                    <h2 class="text-2xl font-bold text-white group-hover:text-neon-cyan transition">${sub.data().title}</h2>
                                    <span class="text-xs font-bold bg-netflix-red text-white px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition"><i class="fas fa-play mr-1"></i> INICIAR JORNADA</span>
                                </div>
                            </div>
                        `;
                        
                        const subUnits = unitSnap.docs.filter(u => u.data().subjectId === sub.id);
                        
                        subUnits.forEach(unit => {
                            html += `
                                <div class="mb-8 ml-4 border-l-2 border-gray-800 pl-4">
                                    <h3 class="text-gray-400 mb-3 text-xs font-bold uppercase tracking-widest flex items-center gap-2"><i class="fas fa-layer-group"></i> ${unit.data().title}</h3>
                                    <div class="scrolling-wrapper pb-4">
                            `;
                            
                            const unitLessons = lessonSnap.docs.filter(l => l.data().unitId === unit.id);
                            
                            if(unitLessons.length === 0) html += `<span class="text-gray-700 text-sm italic p-2">Em breve...</span>`;

                            unitLessons.forEach(lesson => {
                                const ytId = utils.getYouTubeID(lesson.data().videoUrl);
                                const thumb = ytId ? `https://img.youtube.com/vi/${ytId}/mqdefault.jpg` : 'https://placehold.co/300x169/333/999?text=Sem+Imagem';
                                
                                html += `
                                    <div class="card group" onclick="window.playLesson('${lesson.id}')">
                                        <div class="h-40 overflow-hidden rounded-t relative">
                                            <img src="${thumb}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition duration-500">
                                            <div class="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition"><i class="fas fa-play-circle text-5xl text-white"></i></div>
                                        </div>
                                        <div class="p-4 bg-[#181818]">
                                            <h4 class="text-white font-bold text-sm truncate">${lesson.data().title}</h4>
                                            <div class="flex justify-between items-center mt-2"><span class="text-[10px] text-gray-500 uppercase">Aula</span><i class="fas fa-chevron-right text-gray-600 text-xs"></i></div>
                                        </div>
                                    </div>`;
                            });
                            html += `</div></div>`;
                        });
                    });
                    container.innerHTML = html;
                } catch (e) { 
                    console.error(e);
                    if(e.code && e.code.includes('permission-denied')) {
                         container.innerHTML = `<div class="text-center mt-20 text-white">Acesso Restrito. Fa√ßa login.</div>`;
                    } else {
                        container.innerHTML = `<div class="text-center text-red-500 mt-20">Erro cr√≠tico ao carregar home.</div>`; 
                    }
                }
            },

            // --- L√ìGICA DO PLAYER (M√ÅQUINA DE ESTADOS) ---
            renderPlayer: async (container, lessonId) => {
                container.innerHTML = `<div class="flex justify-center mt-20"><div class="loader"></div></div>`;
                
                try {
                    const docSnap = await getDoc(getDocRef("lessons", lessonId));
                    if (!docSnap.exists()) return container.innerHTML = "<div class='text-center text-white mt-20'>Aula n√£o encontrada.</div>";
                    
                    const data = docSnap.data();
                    const ytId = utils.getYouTubeID(data.videoUrl);
                    
                    // Buscar pr√≥ximas aulas para navega√ß√£o
                    const allLessonsSnap = await getDocs(query(getColRef("lessons"), where("unitId", "==", data.unitId)));
                    const lessons = allLessonsSnap.docs.map(d => ({id: d.id, ...d.data()}));
                    lessons.sort((a,b) => a.createdAt.localeCompare(b.createdAt));
                    
                    const currentIndex = lessons.findIndex(l => l.id === lessonId);
                    const nextLessonId = (currentIndex < lessons.length - 1) ? lessons[currentIndex + 1].id : null;

                    // Globais de Controle
                    window.currentPlayerData = { lessonId, nextLessonId, materialUrl: data.materialUrl };

                    container.innerHTML = `
                        <div class="max-w-6xl mx-auto animate-fade-in relative min-h-[85vh] flex flex-col">
                            <!-- Header -->
                            <div class="flex justify-between items-center mb-6 border-b border-gray-800 pb-4">
                                <button onclick="app.router('home')" class="text-gray-400 hover:text-white flex items-center gap-2">
                                    <i class="fas fa-arrow-left"></i> Voltar
                                </button>
                                <div class="text-right">
                                    <h2 class="text-white font-bold text-lg">${data.title}</h2>
                                    <span class="text-xs text-gray-500 uppercase tracking-widest">Aula ${currentIndex+1} de ${lessons.length}</span>
                                </div>
                            </div>

                            <!-- FASE 1: V√çDEO (Entrada) -->
                            <div id="phase1" class="phase-container phase-active w-full flex-1 flex flex-col justify-center">
                                <div class="video-container mx-auto shadow-2xl shadow-purple-900/10 w-full max-w-4xl">
                                    <div id="yt-player"></div>
                                </div>
                                <div class="mt-6 text-center">
                                    <p class="text-gray-400 animate-pulse text-sm"><i class="fas fa-eye"></i> Assista at√© o fim para avan√ßar.</p>
                                    <button onclick="window.nextPhase(2)" class="mt-4 text-xs text-gray-600 hover:text-white underline">Pular V√≠deo (Teste)</button>
                                </div>
                            </div>

                            <!-- FASE 2: REFOR√áO (√Åudio/Resumo) -->
                            <div id="phase2" class="phase-container w-full py-10">
                                <div class="max-w-3xl mx-auto">
                                    <div class="flex items-center gap-4 mb-6">
                                        <div class="w-4 h-4 bg-neon-cyan rounded-full animate-pulse shadow-[0_0_10px_cyan]"></div>
                                        <h2 class="text-3xl font-bold text-white">Refor√ßo do Conte√∫do</h2>
                                    </div>
                                    
                                    <div class="bg-[#1a1a1a] p-8 rounded-xl border border-neon-cyan/30 shadow-lg relative overflow-hidden">
                                        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-neon-cyan to-transparent opacity-50"></div>
                                        <div id="summaryText" class="prose prose-invert prose-lg text-gray-300 leading-relaxed min-h-[100px]">
                                            ${data.summary || "<p>Ouvindo refor√ßo de aprendizado...</p>"}
                                        </div>
                                    </div>

                                    <div class="mt-8 text-center">
                                        <p class="text-sm text-gray-500 italic mb-4 animate-pulse">üîä Ouvindo resumo autom√°tico...</p>
                                        <button onclick="window.skipAudio()" class="text-neon-cyan hover:text-white underline text-sm border border-neon-cyan/50 px-4 py-2 rounded hover:bg-neon-cyan/10">
                                            Pular √Åudio e Ir para Estudo Ativo <i class="fas fa-forward ml-1"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- FASE 3: ESTUDO ATIVO (Material + Conclus√£o) -->
                            <div id="phase3" class="phase-container w-full text-center py-6">
                                <h2 class="text-3xl font-bold mb-6 text-white"><i class="fas fa-book-open mr-2 text-neon-green"></i> Estudo Ativo</h2>
                                
                                ${data.materialUrl ? `
                                    <div class="w-full h-[600px] bg-white rounded-lg shadow-lg overflow-hidden relative mb-4 border border-gray-700">
                                        <iframe src="${data.materialUrl}" class="w-full h-full border-0" allowfullscreen></iframe>
                                    </div>
                                    <div class="mb-8">
                                        <a href="${data.materialUrl}" target="_blank" class="text-neon-green text-sm underline hover:text-white transition">
                                            <i class="fas fa-external-link-alt mr-1"></i> Abrir material em nova aba
                                        </a>
                                    </div>
                                ` : `
                                    <div class="bg-gray-800/50 p-8 rounded inline-block mb-8 border border-gray-700 max-w-lg">
                                        <i class="fas fa-check-circle text-4xl text-neon-green mb-4"></i>
                                        <p class="text-gray-300">Nenhum slide extra para esta aula. Revise suas anota√ß√µes.</p>
                                    </div>
                                `}
                                
                                <div class="mt-6">
                                    <button onclick="window.completeLessonSequence()" class="bg-neon-green text-black font-black px-12 py-5 rounded-full hover:bg-green-400 transition shadow-[0_0_30px_rgba(57,255,20,0.4)] flex items-center gap-3 mx-auto text-lg transform hover:scale-105">
                                        ‚úÖ CONCLUIR AULA
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;

                    // YouTube Setup
                    if (window.YT && window.YT.Player) {
                        new YT.Player('yt-player', {
                            height: '100%', width: '100%', videoId: ytId,
                            playerVars: { 'autoplay': 1, 'controls': 1, 'rel': 0 },
                            events: {
                                'onStateChange': (e) => {
                                    if (e.data === YT.PlayerState.ENDED) window.nextPhase(2);
                                }
                            }
                        });
                    }

                } catch (e) {
                    console.error(e);
                    container.innerHTML = `<div class="text-red-500 text-center mt-20">Erro ao carregar player.</div>`;
                }
            },
            
            startSeries: async (subjectId) => {
                utils.showToast("Buscando conte√∫do...", "info");
                try {
                    const unitsSnap = await getDocs(query(getColRef("units"), where("subjectId", "==", subjectId)));
                    if(unitsSnap.empty) throw new Error("Mat√©ria vazia.");
                    
                    const firstUnit = unitsSnap.docs[0];
                    const lessonSnap = await getDocs(query(getColRef("lessons"), where("unitId", "==", firstUnit.id)));
                    if(lessonSnap.empty) throw new Error("Unidade vazia.");
                    
                    const lessons = lessonSnap.docs.map(d => ({id:d.id, ...d.data()})).sort((a,b) => a.createdAt.localeCompare(b.createdAt));
                    
                    mainApp.router('player', lessons[0].id);
                } catch (error) {
                    utils.showToast(error.message, 'error');
                }
            }
        };

        // ==========================================
        // 4. ADMINISTRA√á√ÉO (CRUD)
        // ==========================================
        const adminManager = {
            init: (container) => {
                if (!state.isAdmin) return mainApp.router('home');
                container.innerHTML = `
                    <div class="max-w-7xl mx-auto animate-fade-in">
                        <header class="mb-8 border-b border-gray-800 pb-6">
                            <h2 class="text-4xl font-black text-white mb-2">CMS ADMIN</h2>
                            <div class="flex gap-2 mt-4">
                                <button onclick="window.renderAdminTab('settings')" class="bg-gray-800 text-white px-4 py-2 rounded">Config</button>
                                <button onclick="window.renderAdminTab('subject')" class="bg-gray-800 text-white px-4 py-2 rounded">Mat√©rias</button>
                                <button onclick="window.renderAdminTab('unit')" class="bg-gray-800 text-white px-4 py-2 rounded">Unidades</button>
                                <button onclick="window.renderAdminTab('lesson')" class="bg-gray-800 text-white px-4 py-2 rounded">Aulas</button>
                            </div>
                        </header>
                        <div id="adminContent" class="bg-[#181818] border border-gray-800 rounded-xl p-6 min-h-[500px]"></div>
                    </div>`;
                window.renderAdminTab('settings');
            },
            renderTab: async (type) => {
                const content = document.getElementById('adminContent');
                content.innerHTML = '<div class="loader mx-auto"></div>';
                state.editingId = null;

                try {
                    if (type === 'settings') {
                        content.innerHTML = `
                            <h3 class="text-xl font-bold text-white mb-6">Configura√ß√µes</h3>
                            <form onsubmit="return false;" class="max-w-2xl space-y-4">
                                <input type="text" id="siteName" value="${state.settings.siteName}" class="w-full p-3 bg-black border border-gray-700 text-white rounded">
                                <input type="text" id="welcomeMsg" value="${state.settings.welcomeMessage}" class="w-full p-3 bg-black border border-gray-700 text-white rounded">
                                <input type="url" id="faviconUrl" value="${state.settings.favicon || ''}" class="w-full p-3 bg-black border border-gray-700 text-white rounded">
                                <button id="btnSettings" onclick="window.saveSettings()" class="bg-neon-purple text-white px-6 py-2 rounded font-bold">Salvar</button>
                            </form>`;
                    } else {
                        const collectionName = type + 's';
                        const snapshot = await getDocs(getColRef(collectionName));
                        const items = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                        
                        let formHtml = '';
                        if (type === 'subject') {
                            formHtml = `<input type="text" id="title" placeholder="Nome da Mat√©ria" class="w-full p-3 bg-black border border-gray-700 text-white rounded">`;
                        } else if (type === 'unit') {
                            const subjects = await getDocs(getColRef('subjects'));
                            const opts = subjects.docs.map(d => `<option value="${d.id}">${d.data().title}</option>`).join('');
                            formHtml = `<select id="subjectId" class="w-full p-3 bg-black border border-gray-700 text-white rounded mb-4">${opts}</select><input type="text" id="title" placeholder="Nome da Unidade" class="w-full p-3 bg-black border border-gray-700 text-white rounded">`;
                        } else if (type === 'lesson') {
                            const units = await getDocs(getColRef('units'));
                            const opts = units.docs.map(d => `<option value="${d.id}">${d.data().title}</option>`).join('');
                            formHtml = `
                                <select id="unitId" class="w-full p-3 bg-black border border-gray-700 text-white rounded mb-4">${opts}</select>
                                <input type="text" id="title" placeholder="T√≠tulo da Aula" class="w-full p-3 bg-black border border-gray-700 text-white rounded mb-4">
                                <input type="url" id="videoUrl" placeholder="Link YouTube" class="w-full p-3 bg-black border border-gray-700 text-white rounded mb-4">
                                <div class="bg-gray-900 rounded border border-gray-700 mb-4"><div id="editor" class="h-40 text-gray-300"></div></div>
                                <input type="url" id="lessonMaterialUrl" placeholder="Link Material (Opcional)" class="w-full p-3 bg-black border border-gray-700 text-white rounded">
                            `;
                        }

                        content.innerHTML = `
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                <div class="lg:col-span-1 border-r border-gray-800 pr-6">
                                    <h3 class="text-xl font-bold text-white mb-4" id="formHeader">Novo Item</h3>
                                    <form onsubmit="return false;">
                                        ${formHtml}
                                        <div class="flex gap-2 pt-4">
                                            <button id="btnSave" onclick="window.handleSave('${type}')" class="flex-1 bg-neon-cyan text-black font-bold py-2 rounded">Salvar</button>
                                            <button id="btnCancel" onclick="window.renderAdminTab('${type}')" class="hidden px-4 text-red-500 font-bold">Cancelar</button>
                                        </div>
                                    </form>
                                </div>
                                <div class="lg:col-span-2">
                                    <h3 class="text-xl font-bold text-gray-400 mb-4">Registros (${items.length})</h3>
                                    <div class="max-h-[500px] overflow-y-auto">
                                        <table class="admin-table w-full text-white">
                                            <thead><tr><th>T√≠tulo</th><th>A√ß√µes</th></tr></thead>
                                            <tbody>
                                                ${items.map(i => `
                                                    <tr>
                                                        <td>${i.title}</td>
                                                        <td>
                                                            <button onclick="window.editItem('${type}', '${i.id}')" class="text-neon-cyan mr-2">Edit</button>
                                                            <button onclick="window.deleteItem('${type}', '${i.id}')" class="text-red-500">Del</button>
                                                        </td>
                                                    </tr>`).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>`;
                        
                        if (type === 'lesson') state.quill = new Quill('#editor', { theme: 'snow' });
                    }
                } catch(e) { console.error(e); }
            },
            handleSave: async (type) => {
                await safeAction('btnSave', `Salvar ${type}`, async () => {
                    const col = type + 's';
                    const data = { 
                        title: document.getElementById('title').value,
                        updatedAt: new Date().toISOString()
                    };
                    if (!state.editingId) data.createdAt = new Date().toISOString();

                    if (type === 'unit') data.subjectId = document.getElementById('subjectId').value;
                    if (type === 'lesson') {
                        data.unitId = document.getElementById('unitId').value;
                        data.videoUrl = document.getElementById('videoUrl').value;
                        data.summary = state.quill.root.innerHTML;
                        data.materialUrl = document.getElementById('lessonMaterialUrl').value || "";
                    }

                    if (state.editingId) await updateDoc(getDocRef(col, state.editingId), data);
                    else await addDoc(getColRef(col), data);
                    
                    utils.showToast("Salvo com sucesso!", "success");
                    window.renderAdminTab(type);
                });
            },
            editItem: async (type, id) => {
                state.editingId = id;
                const docSnap = await getDoc(getDocRef(type + 's', id));
                const data = docSnap.data();
                document.getElementById('title').value = data.title;
                if (type === 'unit') document.getElementById('subjectId').value = data.subjectId;
                if (type === 'lesson') {
                    document.getElementById('unitId').value = data.unitId;
                    document.getElementById('videoUrl').value = data.videoUrl;
                    document.getElementById('lessonMaterialUrl').value = data.materialUrl || "";
                    state.quill.root.innerHTML = data.summary || "";
                }
                document.getElementById('formHeader').innerText = "Editar Item";
                document.getElementById('btnSave').innerText = "Atualizar";
                document.getElementById('btnCancel').classList.remove('hidden');
            },
            deleteItem: async (type, id) => {
                if(confirm("Excluir?")) {
                    await deleteDoc(getDocRef(type + 's', id));
                    window.renderAdminTab(type);
                }
            },
            saveSettings: async () => {
                await safeAction('btnSettings', 'Settings', async () => {
                    const s = {
                        siteName: document.getElementById('siteName').value,
                        welcomeMessage: document.getElementById('welcomeMsg').value,
                        favicon: document.getElementById('faviconUrl').value
                    };
                    await setDoc(getSettingsRef(), s);
                    state.settings = s;
                    mainApp.applySettings();
                    utils.showToast("Configura√ß√µes Salvas", "success");
                });
            }
        };

        // ==========================================
        // 5. EVENTOS GLOBAIS
        // ==========================================

        window.app = mainApp;
        
        window.authManager = {
            toggleModal: (s) => document.getElementById('loginModal').classList.toggle('hidden', !s),
            handleLogin: async () => {
                const e = document.getElementById('emailInput').value, p = document.getElementById('passInput').value;
                await safeAction('btnLogin', 'Login', async () => {
                    await signInWithEmailAndPassword(auth, e, p);
                    window.authManager.toggleModal(false);
                });
            },
            handleRegister: async () => {
                const e = document.getElementById('emailInput').value, p = document.getElementById('passInput').value;
                await safeAction('btnRegister', 'Reg', async () => {
                    await createUserWithEmailAndPassword(auth, e, p);
                    window.authManager.toggleModal(false);
                });
            },
            logout: async () => { await signOut(auth); window.location.reload(); }
        };

        // Admin Bindings
        window.renderAdminTab = adminManager.renderTab;
        window.saveSettings = adminManager.saveSettings;
        window.handleSave = adminManager.handleSave;
        window.editItem = adminManager.editItem;
        window.deleteItem = adminManager.deleteItem;
        window.startSeries = mainApp.startSeries;
        window.playLesson = (id) => mainApp.router('player', id);

        // --- CONTROLE DE FASES (CORRE√á√ÉO DE FLUXO) ---
        window.nextPhase = (phase) => {
            // Limpa estado anterior
            document.querySelectorAll('.phase-container').forEach(el => el.classList.remove('phase-active'));
            window.speechSynthesis.cancel(); // Para qualquer √°udio anterior

            // L√≥gica Fase 2 (Refor√ßo - Auto √Åudio)
            if (phase === 2) {
                const text = utils.stripHtml(document.getElementById('summaryText').innerHTML);
                if (text && text.length > 5) {
                    const u = new SpeechSynthesisUtterance(text);
                    u.lang = 'pt-BR';
                    u.rate = 1.1;
                    u.onend = () => {
                        console.log("√Åudio finalizado. Indo para Fase 3.");
                        window.nextPhase(3); // Auto-avan√ßo
                    };
                    window.speechSynthesis.speak(u);
                } else {
                    // Sem texto, pula direto
                    setTimeout(() => window.nextPhase(3), 1000);
                    return;
                }
            }

            // Ativa nova fase
            const el = document.getElementById(`phase${phase}`);
            if (el) el.classList.add('phase-active');
        };

        window.skipAudio = () => {
            window.speechSynthesis.cancel();
            window.nextPhase(3);
        };

        window.completeLessonSequence = async () => {
            // 1. Salvar Progresso
            if (state.user && !state.user.isAnonymous) {
                try {
                    // Salvar conclus√£o da aula
                    await setDoc(getUserRef(state.user.uid, "progress", window.currentPlayerData.lessonId), { 
                        concluido: true, 
                        date: new Date().toISOString() 
                    });
                    
                    // Salvar "Continuar de onde parou" (Perfil)
                    await setDoc(getUserRef(state.user.uid, "profile", "main"), {
                        lastWatcherLessonId: window.currentPlayerData.lessonId,
                        lastUpdate: new Date().toISOString()
                    }, { merge: true });
                    
                } catch(e) { console.error("Erro ao salvar progresso", e); }
            }

            // 2. Overlay de Contagem
            const app = document.getElementById('app');
            const overlay = document.createElement('div');
            overlay.id = 'countdownOverlay';
            overlay.innerHTML = `
                <div class="text-white text-center">
                    <h2 class="text-4xl font-bold mb-4">Aula Conclu√≠da! üéâ</h2>
                    <p class="text-xl">Pr√≥xima aula em <span id="cnt" class="text-neon-green text-6xl font-black block mt-4">5</span></p>
                </div>
            `;
            app.appendChild(overlay);

            let count = 5;
            const timer = setInterval(() => {
                count--;
                const cntEl = document.getElementById('cnt');
                if(cntEl) cntEl.innerText = count;
                
                if (count <= 0) {
                    clearInterval(timer);
                    if (document.getElementById('countdownOverlay')) document.getElementById('countdownOverlay').remove();
                    
                    if (window.currentPlayerData.nextLessonId) {
                        mainApp.router('player', window.currentPlayerData.nextLessonId);
                    } else {
                        utils.showToast("Unidade Finalizada!", "success");
                        mainApp.router('home');
                    }
                }
            }, 1000);
        };

        onAuthStateChanged(auth, (user) => {
            state.user = user;
            const c = document.getElementById('authContainer');
            if (user) {
                if(!user.isAnonymous) {
                    state.isAdmin = user.email.endsWith('@userpro.com');
                    if(state.isAdmin) document.getElementById('adminBtn').classList.remove('hidden');
                    c.innerHTML = `<button onclick="authManager.logout()" class="text-sm text-gray-400 hover:text-white">Sair</button>`;
                } else {
                    c.innerHTML = `<button onclick="authManager.toggleModal(true)" class="bg-red-600 text-white px-3 py-1 rounded">Entrar</button>`;
                }
                if (state.currentView === 'home') mainApp.init().then(() => mainApp.router('home'));
            } else {
                signInAnonymously(auth).catch(() => {
                    c.innerHTML = `<button onclick="authManager.toggleModal(true)" class="bg-red-600 text-white px-3 py-1 rounded">Entrar</button>`;
                });
            }
        });

    </script>
</body>
</html>
